var t={};!function(){var e={};function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}var n=function(){function t(e,s){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"gray",o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"16px Monospace",l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;i(this,t),this.x=l,this.y=r,this.ctx=e,this.canvas=s,this.color=n,this.font=o,this.setPos=this.setPos.bind(this)}return function(t,e,i){e&&s(t.prototype,e),i&&s(t,i)}(t,[{key:"track",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=this.canvas;return t?e.addEventListener("mousemove",this.setPos):e.removeEventListener("mousemove",this.setPos),this}},{key:"setPos",value:function(t){var e=this.canvas.getBoundingClientRect();return this.x=Math.floor(t.clientX-e.left),this.y=Math.floor(t.clientY-e.top),this}},{key:"draw",value:function(){var t=this.x,e=this.y,i=this.canvas,s=this.ctx,n=this.font,o=this.color,l="X: ".concat(t,", Y: ").concat(e);s.save(),s.fillStyle=o,s.font=n;var r=t<i.width/2?20:-s.measureText(l).width-20,h=e<i.height/2?25:-18;return s.fillText(l,this.x+r,this.y+h),s.restore(),this}}]),t}();function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function r(t,e,i){return e&&l(t.prototype,e),i&&l(t,i),t}var h=function(){function t(e,i,s,n,l,r){o(this,t),this.color=e,this.lineWidth=i,this.startX=s,this.startY=n,this.endX=l,this.endY=r}return r(t,[{key:"draw",value:function(t){var e=this.color,i=this.lineWidth,s=this.startX,n=this.startY,o=this.endX,l=this.endY;t.save(),t.beginPath(),t.strokeStyle=e,t.lineWidth=i,t.moveTo(s,n),t.lineTo(o,l),t.stroke(),t.restore()}}]),t}(),a=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"gray",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:5,l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"DarkGray",r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:.5,h=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"16px Monospace";o(this,t),this.color=e,this.lineWidth=i,this.step=s,this.boldNth=n,this.boldColor=l,this.boldWidth=r,this.font=h,this.lines=null}return r(t,[{key:"createLines",value:function(t){for(var e=this.color,i=this.lineWidth,s=this.step,n=this.boldNth,o=this.boldColor,l=this.boldWidth,r=[],a=n*s,c=0;c<t.width;c+=s){var u=c%a==0;r.push(u?new h(o,l,c,0,c,t.height):new h(e,i,c,0,c,t.height))}for(var d=0;d<t.height;d+=s){var m=d%a==0;r.push(m?new h(o,l,0,d,t.width,d):new h(e,i,0,d,t.width,d))}this.lines=r}},{key:"drawText",value:function(t,e){var i=this.step,s=this.boldNth,n=this.boldColor,o=this.font;t.save(),t.font=o,t.fillStyle=n,t.fillText("0",1,15);for(var l=i*s;l<e.width;l+=i*s)t.fillText(l,l,15);for(var r=i*s;r<e.height;r+=i*s)t.fillText(r,0,r+15);t.restore()}},{key:"draw",value:function(t,e){this.lines||this.createLines(e),this.lines.forEach((function(e){return e.draw(t)})),this.drawText(t,e)}}]),t}();e.Mouse=n,e.Grid=a,t=e}();var e,i={};
/**
 * k-d Tree JavaScript - V 1.01
 *
 * https://github.com/ubilabs/kd-tree-javascript
 *
 * @author Mircea Pricop <pricop@ubilabs.net>, 2012
 * @author Martin Kleppe <kleppe@ubilabs.net>, 2012
 * @author Ubilabs http://ubilabs.net, 2012
 * @license MIT License <http://www.opensource.org/licenses/mit-license.php>
 */e=function(t){function e(t,e,i){this.obj=t,this.left=null,this.right=null,this.parent=i,this.dimension=e}function i(t){this.content=[],this.scoreFunction=t}i.prototype={push:function(t){this.content.push(t),this.bubbleUp(this.content.length-1)},pop:function(){var t=this.content[0],e=this.content.pop();return this.content.length>0&&(this.content[0]=e,this.sinkDown(0)),t},peek:function(){return this.content[0]},remove:function(t){for(var e=this.content.length,i=0;i<e;i++)if(this.content[i]==t){var s=this.content.pop();return void(i!=e-1&&(this.content[i]=s,this.scoreFunction(s)<this.scoreFunction(t)?this.bubbleUp(i):this.sinkDown(i)))}throw new Error("Node not found.")},size:function(){return this.content.length},bubbleUp:function(t){for(var e=this.content[t];t>0;){var i=Math.floor((t+1)/2)-1,s=this.content[i];if(!(this.scoreFunction(e)<this.scoreFunction(s)))break;this.content[i]=e,this.content[t]=s,t=i}},sinkDown:function(t){for(var e=this.content.length,i=this.content[t],s=this.scoreFunction(i);;){var n=2*(t+1),o=n-1,l=null;if(o<e){var r=this.content[o],h=this.scoreFunction(r);h<s&&(l=o)}if(n<e){var a=this.content[n];this.scoreFunction(a)<(null==l?s:h)&&(l=n)}if(null==l)break;this.content[t]=this.content[l],this.content[l]=i,t=l}}},t.kdTree=function(t,s,n){var o=this;Array.isArray(t)?this.root=function t(i,s,o){var l,r,h=s%n.length;return 0===i.length?null:1===i.length?new e(i[0],h,o):(i.sort((function(t,e){return t[n[h]]-e[n[h]]})),(r=new e(i[l=Math.floor(i.length/2)],h,o)).left=t(i.slice(0,l),s+1,r),r.right=t(i.slice(l+1),s+1,r),r)}(t,0,null):function(t){o.root=t,function t(e){e.left&&(e.left.parent=e,t(e.left)),e.right&&(e.right.parent=e,t(e.right))}(o.root)}(t),this.toJSON=function(t){t||(t=this.root);var i=new e(t.obj,t.dimension,null);return t.left&&(i.left=o.toJSON(t.left)),t.right&&(i.right=o.toJSON(t.right)),i},this.insert=function(t){var i,s,o=function e(i,s){if(null===i)return s;var o=n[i.dimension];return t[o]<i.obj[o]?e(i.left,i):e(i.right,i)}(this.root,null);null!==o?(i=new e(t,(o.dimension+1)%n.length,o),s=n[o.dimension],t[s]<o.obj[s]?o.left=i:o.right=i):this.root=new e(t,0,null)},this.remove=function(t){var e;null!==(e=function e(i){if(null===i)return null;if(i.obj===t)return i;var s=n[i.dimension];return t[s]<i.obj[s]?e(i.left):e(i.right)}(o.root))&&function t(e){function i(t,e){var s,o,l,r,h;return null===t?null:(s=n[e],t.dimension===e?null!==t.left?i(t.left,e):t:(o=t.obj[s],l=i(t.left,e),r=i(t.right,e),h=t,null!==l&&l.obj[s]<o&&(h=l),null!==r&&r.obj[s]<h.obj[s]&&(h=r),h))}var s,l,r;if(null===e.left&&null===e.right)return null===e.parent?void(o.root=null):(r=n[e.parent.dimension],void(e.obj[r]<e.parent.obj[r]?e.parent.left=null:e.parent.right=null));null!==e.right?(l=(s=i(e.right,e.dimension)).obj,t(s),e.obj=l):(l=(s=i(e.left,e.dimension)).obj,t(s),e.right=e.left,e.left=null,e.obj=l)}(e)},this.nearest=function(t,e,l){var r,h,a;if(a=new i((function(t){return-t[1]})),l)for(r=0;r<e;r+=1)a.push([null,l]);for(o.root&&function i(o){function l(t,i){a.push([t,i]),a.size()>e&&a.pop()}var r,h,c,u,d=n[o.dimension],m=s(t,o.obj),f={};for(u=0;u<n.length;u+=1)u===o.dimension?f[n[u]]=t[n[u]]:f[n[u]]=o.obj[n[u]];h=s(f,o.obj),null!==o.right||null!==o.left?(i(r=null===o.right?o.left:null===o.left?o.right:t[d]<o.obj[d]?o.left:o.right),(a.size()<e||m<a.peek()[1])&&l(o,m),(a.size()<e||Math.abs(h)<a.peek()[1])&&null!==(c=r===o.left?o.right:o.left)&&i(c)):(a.size()<e||m<a.peek()[1])&&l(o,m)}(o.root),h=[],r=0;r<Math.min(e,a.content.length);r+=1)a.content[r][0]&&h.push([a.content[r][0].obj,a.content[r][1]]);return h},this.balanceFactor=function(){return function t(e){return null===e?0:Math.max(t(e.left),t(e.right))+1}(o.root)/(Math.log(function t(e){return null===e?0:t(e.left)+t(e.right)+1}(o.root))/Math.log(2))}},t.BinaryHeap=i},"function"==typeof define&&define.amd?define(["exports"],e):e(i);class s{inputLast="";inputQueue=[];constructor(){this.deviceCheck=document.getElementById("deviceCheck"),this.deviceConnect=document.getElementById("deviceConnect"),this.deviceDisconnect=document.getElementById("deviceDisconnect"),this.deviceInput=document.getElementById("deviceInput"),this.deviceInputForm=document.getElementById("deviceInputForm"),this.deviceInfo=document.getElementById("deviceInfo"),this.deviceLog=document.getElementById("deviceLog"),this.deviceSerial=document.getElementById("deviceSerial"),this.port=null,this.textDecoder=new TextDecoderStream,this.deviceCheck&&this.deviceConnect&&this.deviceDisconnect&&this.deviceInput&&this.deviceInputForm&&(this.deviceCheck.onclick=this.serialCheck.bind(this),this.deviceConnect.onclick=this.serialConnect.bind(this),this.deviceDisconnect.onclick=this.serialDisconnect.bind(this),this.deviceInputForm.onsubmit=this.serialInputForm.bind(this)),this.serialCheck()}async serialConnect(){navigator.serial.requestPort().then((t=>{console.log("serialConnect",t),this.serialPortOpen(t)})).catch((t=>{this.serialError(t)}))}async serialConnectDevice(t,e){for(let i of this.ports){console.log("serialConnectDevice: serial available, ports: ",i.getInfo());const{usbProductId:s,usbVendorId:n}=i.getInfo();if(s==e&&n==t){this.serialPortOpen(i);break}}}async serialDisconnect(){this.port&&this.port.close().then((()=>{this.port=null,console.log("port closed")})).catch((t=>{console.warn(t)}))}async serialWriteWait(t,e=1e4){return this.inputQueue=[],new Promise((async(i,s)=>{if(this.port)try{this.serialWrite(t);let n=!1;const o=10;let l=e;for(;!(n||(n=await this.serialAvail(o),l-=o,l<=0)););if(console.log(`serialWriteWait avail:${n} time:${e-l}`),console.log(`serialWriteWait check: ${this.inputQueue.length}`),this.inputQueue.length>0){i(this.inputQueue.pop())}else s("timeout")}catch(t){s("busy")}else s("disconnected")}))}serialInputForm(t){this.deviceInput&&(t.preventDefault(),this.serialInputChange(t))}async serialInputChange(t){if(this.deviceInput)if(this.port){let t=this.deviceInput.value;t.length>0&&this.serialWrite(t)}else console.warn("serialInputChange - no port open")}async serialCheck(){let t=!1;return"serial"in navigator?(this.updatePorts(),navigator.serial.addEventListener("connect",(t=>{console.log("serialCheck:connect",t),this.updatePorts()})),navigator.serial.addEventListener("disconnect",(t=>{console.log("serialCheck:disconnect",t)})),t=!0):this.serialError("This browser does not support the serial port. Connection to device impossible! Use Chrome!"),t}updatePorts(){navigator.serial.getPorts().then((t=>{console.log("updatePorts:",t),this.ports=t;let e="";for(let i of t){console.log("serial available, ports: ",i.getInfo());const{usbProductId:t,usbVendorId:s}=i.getInfo();console.log(`updatePorts port pid:${t} vid:${s}`),e+=`<div class="w3-container"><i class="fa-solid fa-microchip"></i> pid:${t} vid:${s} <button class="w3-btn w3-round w3-light-grey w3-tiny" id="${s}-${t}"><i class="fa fa-plug"></i> connect </button></div>`}if(this.deviceInfo){this.deviceInfo.innerHTML=e;const t=this.deviceInfo.getElementsByTagName("button");for(const e of t)e.onclick=()=>{const t=e.id.split("-");console.log(t),this.serialConnectDevice(parseInt(t[0]),parseInt(t[1]))}}!this.deviceConnect||null!=this.ports&&0!=this.ports.length||(this.deviceConnect.className=this.deviceConnect.className.replace("w3-hide","w3-show"))}))}serialPortOpen(t){t.onconnect=()=>{console.log("CONNECTED")},t.ondisconnect=()=>{console.log("DISCONNECTED"),this.onSerialDisconnected&&this.onSerialDisconnected()},t.open({baudRate:25e4}).then((e=>{this.port=t,this.deviceLog&&(this.deviceLog.innerHTML="connected<br>"),console.log("port opened ? ",this.port),this.onSerialConnected&&this.onSerialConnected(),setTimeout(this.serialRead.bind(this),0)})).catch((t=>{this.serialError(t.toString())}))}serialError(t){console.warn("serialError",t),this.deviceLog&&(this.deviceLog.innerHTML=`<span class="w3-red">${t}</span><br>`)}async serialRead(){if(this.port){this.port.readable.pipeTo(this.textDecoder.writable);this.reader=this.textDecoder.readable.getReader(),setTimeout(this.serialReadon.bind(this),1)}}async serialReadon(){try{const{value:t,done:e}=await this.reader.read();if(e)this.reader.releaseLock(),console.log("serialRead - done");else{let e=!1;if(-1!=t.indexOf("\n")){const i=t.split("\n");i.length<=1&&console.error("Assertion failed ",i);for(let t=0;t<i.length-1;t++)this.inputLast+=i[t],this.inputQueue.push(this.inputLast),this.serialLog(this.inputLast,!0),this.inputLast="",e=!0;this.inputLast=i[i.length-1]}else this.inputLast+=t;e&&setTimeout(this.serialCallback.bind(this),5),setTimeout(this.serialReadon.bind(this),1)}}catch(t){console.warn(t),this.serialError(t.toString())}}serialCallback(){}async serialWrite(t){this.serialLog(t,!1);let e=new TextEncoder;const i=this.port.writable.getWriter();await i.write(e.encode(`${t}\n`)),i.releaseLock()}serialAvail(t=10){return new Promise((e=>{this.inputQueue.length>0?e(!0):setTimeout((()=>{e(!1)}),t)}))}serialLog(t,e){if(this.deviceSerial){for(;this.deviceSerial.childElementCount>20;){let t=this.deviceSerial.firstChild;t&&this.deviceSerial.removeChild(t)}this.deviceSerial.innerHTML+=e?`<div><i class="fa-solid fa-arrow-right-to-bracket"></i> ${t}</div>`:`<div><i class="fa-solid fa-arrow-up-right-from-square"></i> ${t}</div>`,globalThis.resize()}}}class n{minx=99999;miny=99999;maxx=-99999;maxy=-99999;constructor(){}updateFromPad(t){this.update(t.posX,t.posY)}update(t,e){t<this.minx&&(this.minx=t),e<this.miny&&(this.miny=e),t>this.maxx&&(this.maxx=t),e>this.maxy&&(this.maxy=e)}center(t=1){return[(this.minx+(this.maxx-this.minx)/2)*t,(this.miny+(this.maxy-this.miny)/2)*t]}zero(t=1){return[this.minx*t,this.miny*t]}size(t=1){return[(this.maxx-this.minx)*t,(this.maxy-this.miny)*t]}diagonal(t=1){const e=this.size(t);return Math.sqrt(e[0]*e[0]+e[1]*e[1])}inside(t){return t.posX>=this.minx&&t.posX<=this.maxx&&t.posY>=this.miny&&t.posY<=this.maxy}}class o{constructor(t,e,i){this.form=t,this.width=e,this.height=i}}class l{constructor(t,e,i){this.posX=e,this.posY=i,this.style=t}asTuple(){return[this.posX,this.posY]}}class r{fileName="";mouseFlag=!1;mouseStartX=0;mouseStartY=0;mouseOffX=0;mouseOffY=0;zoom=5;nearest=[];constructor(t,e){this.ctx=t,this.canvas=e,this.mapStyles=new Map,this.mapPads=new Map,this.bbPcb=new n,this.bbZero=new n,this.bbSelection=new n}setZero(){let t=!1;this.bbZero=this.bbSelection,t=!0,console.log(`Pcb:setZero: ${this.bbZero.zero()}`)}getZero(){return this.bbZero.zero()}getSelected(){let t=[];for(let e of this.nearest)e.length>0&&t.push(e[0]);return t}getSelectedZero(){return this.bbSelection.zero()}zoomToFit(t){let e=this.bbPcb.size(),i=t[0]/e[0],s=t[1]/e[1];this.zoom=.9*(i>s?s:i),console.log(`Pcb:zoomToFit zoom ${this.zoom}`,e),this.center()}center(){this.canvas&&(this.mouseOffX=-this.bbPcb.center()[0]*this.zoom+this.canvas.width/2,this.mouseOffY=-this.bbPcb.center()[1]*this.zoom+this.canvas.height/2)}addPadStyle(t,e,i,s){this.mapStyles.set(t,new o(e,i,s))}addPad(t,e,i){this.mapPads.has(t)||this.mapPads.set(t,new Set);let s=this.mapPads.get(t);if(s){const n=new l(t,e,i);s.add(n),this.bbPcb.update(e,i)}}retree(){try{let t=[];for(let e of this.mapPads.values())for(let i of e)t.push(i);this.tree=new(0,i.kdTree)(t,r.distance,["posX","posY"]),console.log("tree bf:",this.tree.balanceFactor())}catch(t){console.error(t)}}mouseDown(t){const e=this.ctx.getTransform();if(0==t.button){const i=(t.clientX*e.a-this.mouseOffX)/this.zoom,s=(this.canvas.height-(t.clientY-this.canvas.offsetTop)-this.mouseOffY)/this.zoom;this.mouseStartX=i,this.mouseStartY=s,this.mouseSelectX=i,this.mouseSelectY=s,this.mouseSelect=!0,console.log(`Pcb:mouseDown: x:${this.mouseStartX} y:${this.mouseStartY}`)}0!=t.button&&(this.mouseStartX=t.clientX*e.a-this.mouseOffX,this.mouseStartY=t.clientY*e.d-this.mouseOffY,this.mouseFlag=!0)}mouseUp(t){const e=this.ctx.getTransform();if(console.log("pcb:mouseUp event:",t),0!=t.button&&(this.mouseFlag=!1),0==t.button){this.mouseSelect=!1;const i=(t.clientX*e.a-this.mouseOffX)/this.zoom,s=(this.canvas.height-(t.clientY-this.canvas.offsetTop)-this.mouseOffY)/this.zoom;this.mouseSelectX=i,this.mouseSelectY=s,this.bbSelection=new n,this.bbSelection.update(this.mouseStartX,this.mouseStartY),this.bbSelection.update(this.mouseSelectX,this.mouseSelectY);let o=new l("",this.bbSelection.center()[0],this.bbSelection.center()[1]);if(this.tree){let e=[],i=this.bbSelection.diagonal();if(i<.1)e=this.tree.nearest(o,1,i),this.nearest=e;else{i=i/2*(i/2),e=this.tree.nearest(o,99999,i),t.shiftKey||(this.nearest=[]);for(const t of e)this.bbSelection.inside(t[0])&&this.nearest.push(t)}let s=new n;for(const t of this.nearest)s.updateFromPad(t[0]);this.bbSelection=s,console.log(`Pcb:mouseUp found #${e.length}`)}}}mouseMove(t){const e=this.ctx.getTransform();if(this.mouseFlag&&(this.mouseOffX=t.clientX*e.a-this.mouseStartX,this.mouseOffY=t.clientY*e.d-this.mouseStartY),this.mouseSelect){const i=(t.clientX*e.a-this.mouseOffX)/this.zoom,s=(this.canvas.height-(t.clientY-this.canvas.offsetTop)-this.mouseOffY)/this.zoom;this.mouseSelectX=i,this.mouseSelectY=s}}mouseWheel(t){this.ctx.getTransform();t.deltaY>0?this.zoom*=1.1:this.zoom*=.9}mouseOut(t){}static distance(t,e){return Math.pow(t.posX-e.posX,2)+Math.pow(t.posY-e.posY,2)}draw(){this.ctx.fillStyle="antiquewhite",this.ctx.strokeStyle="red";let t=this.bbPcb.center(this.zoom);this.ctx.beginPath(),this.ctx.moveTo(t[0]-10+this.mouseOffX,t[1]+this.mouseOffY),this.ctx.lineTo(t[0]+10+this.mouseOffX,t[1]+this.mouseOffY),this.ctx.moveTo(t[0]+this.mouseOffX,t[1]-10+this.mouseOffY),this.ctx.lineTo(t[0]+this.mouseOffX,t[1]+10+this.mouseOffY),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.rect(this.bbPcb.zero(this.zoom)[0]+this.mouseOffX,this.bbPcb.zero(this.zoom)[1]+this.mouseOffY,this.bbPcb.size(this.zoom)[0],this.bbPcb.size(this.zoom)[1]),this.ctx.stroke();for(let t of this.mapPads.keys()){const e=this.mapStyles.get(t),i=this.mapPads.get(t);if(e&&i){const t=e.width*this.zoom,s=e.height*this.zoom;for(let n of i.values())if("R"==e.form||"O"==e.form||"RoundRect"==e.form)this.ctx.beginPath(),this.ctx.fillRect(n.posX*this.zoom-t/2+this.mouseOffX,n.posY*this.zoom-s/2+this.mouseOffY,t,s),this.ctx.fill();else{if("C"!=e.form){console.log(`draw quatsch ${e.form}`);break}this.ctx.beginPath(),this.ctx.ellipse(n.posX*this.zoom+this.mouseOffX,n.posY*this.zoom+this.mouseOffY,t/2,t/2,0,0,2*Math.PI),this.ctx.fill()}}}this.ctx.strokeStyle="purple",this.ctx.beginPath();let e=.5;for(const t of this.nearest)this.ctx.moveTo((t[0].posX-e)*this.zoom+this.mouseOffX,t[0].posY*this.zoom+this.mouseOffY),this.ctx.lineTo((t[0].posX+e)*this.zoom+this.mouseOffX,t[0].posY*this.zoom+this.mouseOffY),this.ctx.moveTo(t[0].posX*this.zoom+this.mouseOffX,(t[0].posY+e)*this.zoom+this.mouseOffY),this.ctx.lineTo(t[0].posX*this.zoom+this.mouseOffX,(t[0].posY-e)*this.zoom+this.mouseOffY);this.ctx.stroke();let i=[0,0];this.bbSelection&&(e=2*this.zoom,i=this.bbSelection.zero(this.zoom),this.ctx.beginPath(),this.ctx.moveTo(i[0]-e+this.mouseOffX,i[1]+this.mouseOffY),this.ctx.lineTo(i[0]+e+this.mouseOffX,i[1]+this.mouseOffY),this.ctx.moveTo(i[0]+this.mouseOffX,i[1]-e+this.mouseOffY),this.ctx.lineTo(i[0]+this.mouseOffX,i[1]+e+this.mouseOffY),this.ctx.stroke()),this.ctx.strokeStyle="black",i=this.bbZero.center(this.zoom),this.ctx.beginPath(),this.ctx.moveTo(-e+this.mouseOffX,this.mouseOffY),this.ctx.lineTo(+e+this.mouseOffX,this.mouseOffY),this.ctx.moveTo(this.mouseOffX,-e+this.mouseOffY),this.ctx.lineTo(this.mouseOffX,+e+this.mouseOffY),this.ctx.stroke(),this.ctx.strokeStyle="black",i=this.bbZero.zero(this.zoom),this.ctx.beginPath(),this.ctx.moveTo(i[0]-e+this.mouseOffX,i[1]+this.mouseOffY),this.ctx.lineTo(i[0]+e+this.mouseOffX,i[1]+this.mouseOffY),this.ctx.moveTo(i[0]+this.mouseOffX,i[1]-e+this.mouseOffY),this.ctx.lineTo(i[0]+this.mouseOffX,i[1]+e+this.mouseOffY),this.ctx.stroke(),this.mouseSelect&&(this.ctx.strokeStyle="purple",this.ctx.beginPath(),this.ctx.moveTo(this.mouseStartX*this.zoom+this.mouseOffX,this.mouseStartY*this.zoom+this.mouseOffY),this.ctx.lineTo(this.mouseSelectX*this.zoom+this.mouseOffX,this.mouseStartY*this.zoom+this.mouseOffY),this.ctx.lineTo(this.mouseSelectX*this.zoom+this.mouseOffX,this.mouseSelectY*this.zoom+this.mouseOffY),this.ctx.lineTo(this.mouseStartX*this.zoom+this.mouseOffX,this.mouseSelectY*this.zoom+this.mouseOffY),this.ctx.lineTo(this.mouseStartX*this.zoom+this.mouseOffX,this.mouseStartY*this.zoom+this.mouseOffY),this.ctx.stroke())}}let h;var a;(a=h||(h={}))[a.Undefined=1]="Undefined",a[a.Ready=2]="Ready",a[a.Busy=3]="Busy",a[a.NC=4]="NC";class c{constructor(t){this.pcb=t}}class u extends c{reNumFormat=/^%FSLAX([0-9])([0-9])Y([0-9])([0-9])[*]%/;reMatchPad=/^(%AD)(D[0-9]+)([A-Za-z]+)[,]([-0-9.]+)[X]?([-0-9.]+)?[X]?([-0-9.]+)?/;reMatchPadCoordInit=/^([DG][0-9]+)[*]/;reMatchPadCoord=/^X([-]?)([0-9]+)Y([-]?)([0-9]+)D([0-9]+)[*]/;_cancel=!1;floatFracts=1;floatDezis=1;lastPad="";constructor(t){super(t)}parseFile(t){return new Promise((e=>{t.arrayBuffer().then((t=>{var i,s,n,o;i="UTF-8",s=t=>{this.processGerberText(t).finally((()=>{e()}))},n=new Blob([t],{type:"text/plain"}),(o=new FileReader).onload=t=>{t.target&&s(t.target.result)},o.readAsText(n,i)}))}))}cancel(){this._cancel=!0}async processGerberText(t){const e=(t=t.replace(/\r/g,"")).split("\n");let i=1;for(let t of e){if(i++,this._cancel){this._cancel=!1;break}await this.processGerberLine(t),this.processCB&&this.processCB(100*i/e.length)}this.pcb.retree()}async processGerberLine(t){return new Promise((e=>{const i=this.reNumFormat.exec(t);i&&(this.floatDezis=parseInt(i[1]),this.floatFracts=parseInt(i[2]),console.log(`gerber: float digits = ${this.floatDezis} ${this.floatFracts}`));const s=this.reMatchPad.exec(t);s&&(this.padsField&&(this.padsField.innerHTML+=`${s[2]} ${s[3]} ${s[4]} ${s[5]}<br>`),"RoundRect"==s[3]?this.pcb.addPadStyle(s[2],s[3],Math.abs(parseFloat(s[5])),Math.abs(parseFloat(s[6]))):this.pcb.addPadStyle(s[2],s[3],parseFloat(s[4]),parseFloat(s[5])));const n=this.reMatchPadCoordInit.exec(t);n&&(this.lastPad=n[1]);const o=this.reMatchPadCoord.exec(t);if(o)if(this.lastPad.startsWith("D")){let t=o[2],e=o[4];const i=this.floatDezis+this.floatFracts;for(;t.length<i;)t=`0${t}`;for(;e.length<i;)e=`0${e}`;let s=0,n=0;t=`${t.substring(0,this.floatDezis)}.${t.substring(this.floatDezis)}`,e=`${e.substring(0,this.floatDezis)}.${e.substring(this.floatDezis)}`,s=parseFloat(t),n=parseFloat(e),"-"==o[1]&&(s*=-1),"-"==o[3]&&(n*=-1),this.coordsField&&(this.coordsField.innerHTML+=`${this.lastPad}:  x:${s} y:${n} <br>`),this.pcb.addPad(this.lastPad,s,n)}else console.log(`ignoring ${this.lastPad}`);this.pcb.center(),setTimeout(e,0)}))}}const d=document.getElementsByTagName("body")[0],m=document.getElementById("messageElem"),f=document.getElementById("uploadButton"),g=document.getElementById("padsField"),p=document.getElementById("Coords"),b=document.getElementById("coordsField"),v=document.getElementById("dropZone"),w=document.getElementById("canvas"),y=document.getElementById("debug"),x=document.getElementById("progress"),P=document.getElementById("progressbar"),T=document.getElementById("contextMenu"),S=document.getElementById("progressCancel"),B=document.getElementById("menuSetZero"),z=document.getElementById("menuMoveTo"),X=document.getElementById("menuMoveAll"),Y=document.getElementById("menuBlob"),k=document.getElementById("main"),E=document.getElementById("openSidebar"),O=document.getElementsByTagName("header")[0],C=document.getElementById("footer");let I,M,W,D,F=null,$=new class extends s{zero=[0,0];constructor(){super(),this.marlinDiv=document.getElementById("Marlin"),this.initHtml()}setZero(t){this.zero=t,this.onBtnAbs().then((()=>{this.serialWriteWait("G92 X0 Y0 Z0").then((()=>{this.onBtnPos()}))}))}moveTo(t,e,i,s){let n="G0 ";null!=t&&(n+=`X${t-this.zero[0]} `),null!=e&&(n+=`Y${e-this.zero[1]} `),null!=i&&(n+=`Z${i} `),this.serialWriteWait(n).then((()=>{this.onBtnPos()}))}async moveToAll(t){console.log("Marlin: moveToAll",t.length),console.log(t);const e=new(0,i.kdTree)(t,r.distance,["posX","posY"]);let s=t[0];this.onBtnAbs().then((async()=>{for(let i=0;i<t.length;i++){let t=e.nearest(s,1);s=t[0][0],console.log("Marlin: moveToAll",s);let i="G0 ";i+=`X${s.posX-this.zero[0]} `,i+=`Y${s.posY-this.zero[1]} `,await this.serialWriteWait(i),e.remove(s)}}))}blob(){this.onBtnAbs().then((()=>{this.serialWriteWait("M83").then((()=>{this.serialWriteWait("G0 Z3").then((()=>{this.serialWriteWait("G0 E10").then((()=>{this.serialWriteWait("G0 Z0").then((()=>{this.serialWriteWait("G0 Z3")}))}))}))}))}))}onSerialConnected(){console.log("Marlin: onSerialConnected"),this.setStatus(h.Ready),this.marlinDivStatus&&this.marlinDivCommands&&(this.setStatus(h.Ready),this.marlinDivCommands.className=this.marlinDivCommands.className.replace("w3-hide","w3-show")),setTimeout((()=>{this.onBtnCold().then((()=>{this.onBtnRel().then((()=>{this.onBtnPos().then((()=>{console.log("Marlin: onSerialConnected init sequence finished")}))}))}))}),3e3)}onSerialDisconnected(){console.log("Marlin: onSerialDisconnected"),this.marlinDivStatus&&this.marlinDivCommands&&(this.setStatus(h.NC),this.marlinDivCommands.className=this.marlinDivCommands.className.replace("w3-show","w3-hide"))}async serialWriteWait(t,e=1e4){return new Promise((async(i,s)=>{this.setStatus(h.Busy),super.serialWriteWait(t,e).then((t=>{i(t)})).catch((t=>{s(t)})).finally((()=>{this.setStatus(h.Ready)}))}))}setStatus(t){let e=`unknown status ${t}`;switch(t){case h.Ready:e='Status: <i class="fa-solid fa-plug"></i> ready';break;case h.Busy:e='Status: <i class="fa-solid fa-plug-circle-bolt"></i> busy';break;case h.NC:e='Status: <i class="fa-solid fa-plug-circle-xmark"></i> not connected'}this.marlinDivStatus&&(this.marlinDivStatus.innerHTML=e)}onBtnHome(){return new Promise((t=>{this.serialWriteWait("G28").then((t=>{console.log(t)})).catch((t=>{console.warn(t)})).finally((()=>{t()}))}))}onBtnPos(){return new Promise((t=>{this.serialWriteWait("M114").then((t=>{console.log("onBtnPos",t),this.marlinDivPosition&&(this.marlinDivPosition.innerText=t)})).catch((t=>{console.warn(t)})).finally((()=>{t()}))}))}onBtnAbs(){return new Promise((t=>{this.serialWriteWait("G90").then((t=>{console.log(t)})).catch((t=>{console.warn(t)})).finally((()=>{t()}))}))}onBtnRel(){return new Promise((t=>{this.serialWriteWait("G91").then((t=>{console.log(t)})).catch((t=>{console.warn(t)})).finally((()=>{t()}))}))}onBtnCold(){return new Promise((t=>{this.serialWriteWait("M302 S0").then((t=>{console.log(t)})).catch((t=>{console.warn(t)})).finally((()=>{t()}))}))}onBtnXP(){this.serialWriteWait("G0 X10").then((t=>{this.onBtnPos()}))}onBtnXM(){this.serialWriteWait("G0 X-10").then((t=>{this.onBtnPos()}))}onBtnYP(){this.serialWriteWait("G0 Y10").then((t=>{this.onBtnPos()}))}onBtnYM(){this.serialWriteWait("G0 Y-10").then((t=>{this.onBtnPos()}))}onBtnZP(){this.serialWriteWait("G0 Z10").then((t=>{this.onBtnPos()}))}onBtnZM(){this.serialWriteWait("G0 Z-10").then((t=>{this.onBtnPos()}))}onBtnEP(){this.serialWriteWait("G0 E10").then((t=>{this.onBtnPos()}))}onBtnEM(){this.serialWriteWait("G0 E-10").then((t=>{this.onBtnPos()}))}initHtml(){if(this.marlinDiv){this.marlinDiv.innerHTML='\n            <div class="w3-border w3-border-dark-grey">\n            <div id="marlinStatus"></div>\n            <div id="marlinPosition" class="w3-tiny"></div>\n            <div id="marlinCommands" class="w3-tiny w3-hide">\n            <p>\n            <button id="marlinHome" class="w3-button w3-round w3-light-grey">home</button>\n            <button id="marlinPos"  class="w3-button w3-round w3-light-grey">pos?</button>\n            <button id="marlinRel"  class="w3-button w3-round w3-light-grey">rel</button>\n            <button id="marlinAbs"  class="w3-button w3-round w3-light-grey">abs</button>\n            <button id="marlinCold" class="w3-button w3-round w3-light-grey">cold</button>\n            </p>\n            <p>\n            <button id="marlinXP" class="w3-button w3-round w3-light-grey">x+</button>\n            <button id="marlinXM" class="w3-button w3-round w3-light-grey">x-</button>\n            <button id="marlinYP" class="w3-button w3-round w3-light-grey">y+</button>\n            <button id="marlinYM" class="w3-button w3-round w3-light-grey">y-</button>\n            <button id="marlinZP" class="w3-button w3-round w3-light-grey">z+</button>\n            <button id="marlinZM" class="w3-button w3-round w3-light-grey">z-</button>\n            </p>\n            <p>\n            <button id="marlinEP" class="w3-button w3-round w3-light-grey">e+</button>\n            <button id="marlinEM" class="w3-button w3-round w3-light-grey">e-</button>\n            </p>\n            </div>\n            </div>\n            ',this.marlinDivStatus=document.getElementById("marlinStatus"),this.marlinDivPosition=document.getElementById("marlinPosition"),this.marlinDivCommands=document.getElementById("marlinCommands"),this.setStatus(h.NC);const t=document.getElementById("marlinHome");t&&(t.onclick=this.onBtnHome.bind(this));const e=document.getElementById("marlinPos");e&&(e.onclick=this.onBtnPos.bind(this));const i=document.getElementById("marlinRel");i&&(i.onclick=this.onBtnRel.bind(this));const s=document.getElementById("marlinAbs");s&&(s.onclick=this.onBtnAbs.bind(this));const n=document.getElementById("marlinCold");n&&(n.onclick=this.onBtnCold.bind(this));const o=document.getElementById("marlinXP");o&&(o.onclick=this.onBtnXP.bind(this));const l=document.getElementById("marlinXM");l&&(l.onclick=this.onBtnXM.bind(this));const r=document.getElementById("marlinYP");r&&(r.onclick=this.onBtnYP.bind(this));const a=document.getElementById("marlinYM");a&&(a.onclick=this.onBtnYM.bind(this));const c=document.getElementById("marlinZP");c&&(c.onclick=this.onBtnZP.bind(this));const u=document.getElementById("marlinZM");u&&(u.onclick=this.onBtnZM.bind(this));const d=document.getElementById("marlinEP");d&&(d.onclick=this.onBtnEP.bind(this));const m=document.getElementById("marlinEM");m&&(m.onclick=this.onBtnEM.bind(this))}}};function L(){I=void 0,m&&(m.innerHTML="")}function N(){w&&F&&(window.requestAnimationFrame(N),F.setTransform(D?D.zoom:1,0,0,D?D.zoom:1,0,0),F.clearRect(0,0,w.width,w.height),W.lines.forEach((t=>t.draw(F))),M.draw(),F.setTransform(1,0,0,-1,0,w.height),D&&D.draw())}async function R(t){if(g&&b&&F&&w&&x&&P&&S&&v){D=new r(F,w);let e=new u(D);g.innerHTML="",b.innerHTML="",v.innerText=t.name,x.style.display="block",e.padsField=g,e.coordsField=b,S.onclick=()=>{e.cancel()},e.processCB=t=>{P&&(P.style.width=`${t}%`)},await e.parseFile(t),D.zoomToFit([w.width,w.height]),x.style.display="none"}}globalThis.accordionToggler=t=>{var e=document.getElementById(t);e?-1==e.className.indexOf("w3-show")&&-1==e.className.indexOf("w3-hide")?e.className+=" w3-show":-1!=e.className.indexOf("w3-show")?e.className=e.className.replace("w3-show","w3-hide"):e.className=e.className.replace("w3-hide","w3-show"):console.warn("accordionToggler no elem with id:",t),globalThis.resize()},globalThis.openSidebar=()=>{k&&y&&E&&(k.style.marginRight="350px",y.style.width="350px",y.style.display="block",E.style.display="none")},globalThis.closeSidebar=()=>{k&&y&&E&&(k.style.marginRight="0px",y.style.display="none",E.style.display="inline-block")},globalThis.zoomToFit=()=>{D&&w&&D.zoomToFit([w.width,w.height])},globalThis.rotateRight=()=>{var t;t="müsste ma einer implementieren, ne",I&&window.clearTimeout(I),m&&(m.innerHTML=`${t}`,I=window.setTimeout(L,1e4))},globalThis.resize=()=>{if(w&&O&&C&&y&&p){w.width=innerWidth,w.height=innerHeight-O.getBoundingClientRect().height-C.getBoundingClientRect().height,M.draw(),W.draw(F,w);let t=innerHeight-C.getBoundingClientRect().height,e=0;for(let t of y.children){let i=t;-1==i.className.indexOf("w3-hide")&&(e+=i.clientHeight)}-1!=p.className.indexOf("w3-hide")?(y.style.height=`${e+16}px`,p.style.height="16px"):(e-=p.getBoundingClientRect().height,y.style.height=`${t}px`,p.style.height=t-e-16+"px")}},document.addEventListener("DOMContentLoaded",(function(){f&&B&&z&&X&&Y&&S&&g&&b&&d&&w&&C?(F=w.getContext("2d"),w.addEventListener("mousemove",(t=>{D&&D.mouseMove(t),t.preventDefault()}),!1),w.addEventListener("mousedown",(t=>{D&&D.mouseDown(t),t.preventDefault()}),!1),w.addEventListener("mouseup",(t=>{D&&D.mouseUp(t),t.preventDefault()}),!1),w.addEventListener("mouseout",(t=>{D&&D.mouseOut(t),t.preventDefault()}),!1),w.addEventListener("wheel",(t=>{D&&D.mouseWheel(t),t.preventDefault()}),!1),f.onclick=()=>{var t=document.createElement("input");return t.type="file",t.click(),t.addEventListener("change",(e=>{if(console.log(e),t.files&&t.files.length>0){let e=t.files[0];console.log(e),console.log(`file: ${e.name} size:${e.size}`),R(e)}else alert("please choose a file")})),!1},B.onclick=t=>{D.setZero(),$.setZero(D.getZero())},z.onclick=t=>{let e=D.getSelectedZero();$.moveTo(e[0],e[1],void 0,void 0)},X.onclick=t=>{let e=D.getSelected();$.moveToAll(e)},Y.onclick=()=>{$.blob()},d.ondrop=t=>{t.preventDefault(),console.log(t),t.dataTransfer&&t.dataTransfer.items?[...t.dataTransfer.items].forEach(((t,e)=>{if("file"===t.kind){const i=t.getAsFile();i&&(console.log(`… item[${e}].name = ${i.name}`),R(i))}})):t.dataTransfer&&[...t.dataTransfer.files].forEach(((t,e)=>{t&&(console.log(`… file[${e}].name = ${t.name}`),R(t))}))},d.ondragover=t=>{console.log("File(s) in drop zone"),t.preventDefault()},d.oncontextmenu=t=>{t.preventDefault(),T&&(T.style.left=`${t.pageX}px`,T.style.top=`${t.pageY}px`,T.className=T.className.replace("w3-hide","w3-show"))},d.onmouseup=t=>{T&&(T.className=T.className.replace("w3-show","w3-hide"))},w.width=innerWidth,w.height=innerHeight-O.getBoundingClientRect().height-C.getBoundingClientRect().height-7,F&&(D=new r(F,w),M=new(0,t.Mouse)(F,w),M.track(),W=new(0,t.Grid),W.step=2,W.lineWidth=.03,W.boldWidth=.05,W.createLines(w)),globalThis.resize(),window.requestAnimationFrame(N)):console.error("missing html elements !")})),window.addEventListener("resize",(t=>{globalThis.resize()}));
//# sourceMappingURL=index.cfb31f65.js.map
